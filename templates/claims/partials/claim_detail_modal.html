{% load humanize %}
<!-- Modal Content matching the design image -->
<div style="background: white; border-radius: 12px; overflow: hidden;">
    {% csrf_token %}
    
    <!-- Modal Header -->
    <div style="padding: 20px 24px; border-bottom: 1px solid #f1f3f4; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-icons" style="color: #1976d2; font-size: 24px;">description</span>
            <h5 style="margin: 0; font-size: 18px; font-weight: 600; color: #212529;">
                Claim Details - {{ claim.claim_id }}
            </h5>
            {% if claim.status == 'Denied' %}
                <span style="background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">Denied</span>
            {% elif claim.status == 'Paid' %}
                <span style="background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">Paid</span>
            {% else %}
                <span style="background: #cce7ff; color: #004085; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">Under Review</span>
            {% endif %}
        </div>
        <button type="button" onclick="hideClaimModal()" style="background: none; border: none; color: #6c757d; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
            <span class="material-icons">close</span>
        </button>
    </div>

    <!-- Modal Body -->
    <div style="display: flex; min-height: 500px;">
        
        <!-- Left Side - Claim Details -->
        <div style="flex: 1; padding: 24px; background: white;">
            
            <!-- Basic Info Section -->
            <div style="margin-bottom: 28px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Patient:</label>
                        <div style="font-size: 16px; font-weight: 500; color: #212529;">{{ claim.patient_name }}</div>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Discharge Date:</label>
                        <div style="font-size: 16px; color: #212529;">{{ claim.discharge_date|date:"n/j/Y" }}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Billed Amount:</label>
                        <div style="font-size: 18px; font-weight: 600; color: #212529;">${{ claim.billed_amount|floatformat:2|intcomma }}</div>
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Paid Amount:</label>
                        <div style="font-size: 18px; font-weight: 600; {% if claim.paid_amount == 0 %}color: #dc3545;{% else %}color: #28a745;{% endif %}">${{ claim.paid_amount|floatformat:2|intcomma }}</div>
                    </div>
                </div>
            </div>

            <!-- CPT Codes Section -->
            {% if claim.detail and claim.detail.cpt_codes %}
                <div style="margin-bottom: 28px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 8px;">CPT Codes:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        {% for code in claim.detail.cpt_codes_list %}
                            <span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; border: 1px solid #bbdefb;">
                                {{ code }}
                            </span>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Insurer Section -->
            <div style="margin-bottom: 28px;">
                <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Insurer:</label>
                <div style="font-size: 16px; color: #212529;">{{ claim.insurer_name }}</div>
            </div>

            <!-- Denial Reason Section -->
            {% if claim.detail and claim.detail.denial_reason and claim.detail.denial_reason|length > 0 and claim.detail.denial_reason != 'N/A' %}
                <div style="margin-bottom: 28px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 4px;">Denial Reason:</label>
                    <div style="font-size: 14px; color: #dc3545; background: #f8d7da; padding: 12px; border-radius: 6px; border-left: 3px solid #dc3545;">
                        {{ claim.detail.denial_reason }}
                    </div>
                </div>
            {% endif %}

        </div>

        <!-- Right Side - Notes & Annotations -->
        <div style="width: 320px; background: #f8f9fa; border-left: 1px solid #e9ecef; padding: 24px;">
            
            <!-- Section Header -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
                <span class="material-icons" style="font-size: 18px; color: #6c757d;">notes</span>
                <h6 style="margin: 0; font-size: 14px; font-weight: 600; color: #212529;">Notes & Annotations</h6>
            </div>

            <!-- Existing Notes -->
            <div id="notesSection-{{ claim.claim_id }}" style="margin-bottom: 24px;">
                {% for note in claim.notes.all %}
                    <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 3px solid #6c757d;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <span style="background: #e9ecef; color: #495057; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">{{ note.user.username|capfirst }}</span>
                            <span style="font-size: 11px; color: #6c757d;">{{ note.created_at|timesince }} ago</span>
                        </div>
                        <p style="margin: 0; font-size: 13px; color: #495057; line-height: 1.4;">
                            {{ note.note }}
                        </p>
                    </div>
                {% endfor %}

                {% for flag in claim.flags.all %}
                    <div style="background: #fff3cd; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 3px solid #ffc107;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <span style="background: #ffc107; color: #856404; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">Flag - {{ flag.flag_type|capfirst }}</span>
                            <span style="font-size: 11px; color: #6c757d;">{{ flag.created_at|timesince }} ago</span>
                        </div>
                        <p style="margin: 0; font-size: 13px; color: #856404; line-height: 1.4;">
                            {{ flag.reason }}
                        </p>
                    </div>
                {% endfor %}

                {% if not claim.notes.all and not claim.flags.all %}
                    <div style="text-align: center; padding: 24px; color: #6c757d;">
                        <span class="material-icons" style="font-size: 32px; opacity: 0.5; margin-bottom: 8px; display: block;">note</span>
                        No notes or flags yet
                    </div>
                {% endif %}
            </div>

            <!-- Quick Actions Section -->
            <div>
                <h6 style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #212529;">Quick Actions</h6>
                
                <!-- Flag Form -->
                <div id="flagForm-{{ claim.claim_id }}" style="display: none; margin-bottom: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 8px;">Flag Reason:</label>
                    <textarea 
                        id="flagReason-{{ claim.claim_id }}"
                        placeholder="Enter reason for flagging this claim..."
                        style="width: 100%; height: 60px; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; font-size: 13px; resize: vertical; margin-bottom: 8px;"
                    ></textarea>
                    <div style="display: flex; gap: 8px;">
                        <button 
                            onclick="submitFlag('{{ claim.claim_id }}')"
                            style="flex: 1; padding: 8px; background: #ffc107; color: #856404; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer;"
                        >
                            Add Flag
                        </button>
                        <button 
                            onclick="cancelFlag('{{ claim.claim_id }}')"
                            style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer;"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Note Form -->
                <div id="noteForm-{{ claim.claim_id }}" style="display: none; margin-bottom: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #6c757d; margin-bottom: 8px;">Add Note:</label>
                    <textarea 
                        id="noteText-{{ claim.claim_id }}"
                        placeholder="Enter your note or annotation..."
                        style="width: 100%; height: 80px; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; font-size: 13px; resize: vertical; margin-bottom: 8px;"
                    ></textarea>
                    <div style="display: flex; gap: 8px;">
                        <button 
                            onclick="submitNote('{{ claim.claim_id }}')"
                            style="flex: 1; padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer;"
                        >
                            Add Note
                        </button>
                        <button 
                            onclick="cancelNote('{{ claim.claim_id }}')"
                            style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer;"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
                
                <button 
                    id="flagButton-{{ claim.claim_id }}"
                    onclick="showFlagForm('{{ claim.claim_id }}')"
                    style="width: 100%; padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; color: #495057; font-size: 13px; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;"
                    onmouseover="this.style.background='#f8f9fa';"
                    onmouseout="this.style.background='white';"
                >
                    <span class="material-icons" style="font-size: 16px;">flag</span>
                    Flag for Review
                </button>
                
                <button 
                    id="noteButton-{{ claim.claim_id }}"
                    onclick="showNoteForm('{{ claim.claim_id }}')"
                    style="width: 100%; padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; color: #495057; font-size: 13px; cursor: pointer; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;"
                    onmouseover="this.style.background='#f8f9fa';"
                    onmouseout="this.style.background='white';"
                >
                    <span class="material-icons" style="font-size: 16px;">note_add</span>
                    Add Note
                </button>
                
                <button 
                    onclick="generateReport('{{ claim.claim_id }}')"
                    style="width: 100%; padding: 12px; background: white; border: 1px solid #dee2e6; border-radius: 6px; color: #495057; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;"
                    onmouseover="this.style.background='#f8f9fa';"
                    onmouseout="this.style.background='white';"
                >
                    <span class="material-icons" style="font-size: 16px;">description</span>
                    Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show/Hide Flag Form
function showFlagForm(claimId) {
    document.getElementById(`flagForm-${claimId}`).style.display = 'block';
    document.getElementById(`flagButton-${claimId}`).style.display = 'none';
    document.getElementById(`noteButton-${claimId}`).style.display = 'none';
    document.getElementById(`flagReason-${claimId}`).focus();
}

function cancelFlag(claimId) {
    document.getElementById(`flagForm-${claimId}`).style.display = 'none';
    document.getElementById(`flagButton-${claimId}`).style.display = 'flex';
    document.getElementById(`noteButton-${claimId}`).style.display = 'flex';
    document.getElementById(`flagReason-${claimId}`).value = '';
}

function submitFlag(claimId) {
    const reason = document.getElementById(`flagReason-${claimId}`).value.trim();
    if (!reason) {
        alert('Please enter a reason for flagging this claim.');
        return;
    }

    htmx.ajax('POST', `/htmx/add-flag/${claimId}/`, {
        values: { 
            'reason': reason,
            'flag_type': 'review',
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        target: `#notesSection-${claimId}`,
        swap: 'outerHTML'
    }).then(() => {
        console.log('Flag added successfully');
        cancelFlag(claimId);
        
        // Update the flag icon in the parent claims list
        updateFlagInList(claimId, true);
    }).catch((error) => {
        console.error('Error adding flag:', error);
        alert('Error adding flag. Please try again.');
    });
}

// Show/Hide Note Form
function showNoteForm(claimId) {
    document.getElementById(`noteForm-${claimId}`).style.display = 'block';
    document.getElementById(`flagButton-${claimId}`).style.display = 'none';
    document.getElementById(`noteButton-${claimId}`).style.display = 'none';
    document.getElementById(`noteText-${claimId}`).focus();
}

function cancelNote(claimId) {
    document.getElementById(`noteForm-${claimId}`).style.display = 'none';
    document.getElementById(`flagButton-${claimId}`).style.display = 'flex';
    document.getElementById(`noteButton-${claimId}`).style.display = 'flex';
    document.getElementById(`noteText-${claimId}`).value = '';
}

function submitNote(claimId) {
    const noteText = document.getElementById(`noteText-${claimId}`).value.trim();
    if (!noteText) {
        alert('Please enter a note.');
        return;
    }

    htmx.ajax('POST', `/htmx/add-note/${claimId}/`, {
        values: { 
            'note_text': noteText,
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        target: `#notesSection-${claimId}`,
        swap: 'outerHTML'
    }).then(() => {
        console.log('Note added successfully');
        cancelNote(claimId);
    }).catch((error) => {
        console.error('Error adding note:', error);
        alert('Error adding note. Please try again.');
    });
}

function generateReport(claimId) {
    // Show message that it's not in requirements
    const message = document.createElement('div');
    message.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fff3cd; color: #856404; padding: 12px 16px; border-radius: 6px; border: 1px solid #ffeaa7; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10000; font-size: 14px;';
    message.textContent = 'Generate Report: Not mentioned in requirements';
    document.body.appendChild(message);
    
    setTimeout(() => {
        document.body.removeChild(message);
    }, 3000);
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Close any open forms when ESC is pressed
        const claimId = document.querySelector('[id^="flagForm-"]')?.id.split('-')[1];
        if (claimId) {
            if (document.getElementById(`flagForm-${claimId}`).style.display === 'block') {
                cancelFlag(claimId);
            }
            if (document.getElementById(`noteForm-${claimId}`).style.display === 'block') {
                cancelNote(claimId);
            }
        }
    }
});

// Function to update flag icon in the parent claims list
function updateFlagInList(claimId, hasFlagged) {
    // Check if we're in a modal (parent window has the claims list)
    const parentWindow = window.parent || window;
    
    // Try to find the claim row in the parent document
    const claimRows = parentWindow.document.querySelectorAll('[data-claim-id]');
    
    for (let row of claimRows) {
        if (row.getAttribute('data-claim-id') === claimId) {
            const actionsDiv = row.querySelector('.claim-actions');
            if (actionsDiv && hasFlagged) {
                // Check if flag icon already exists
                const existingFlag = actionsDiv.querySelector('.flag-icon');
                if (!existingFlag) {
                    // Create and add flag icon
                    const flagIcon = parentWindow.document.createElement('span');
                    flagIcon.className = 'flag-icon';
                    flagIcon.style.cssText = 'color: #dc3545; display: flex; align-items: center; font-size: 16px; padding: 4px;';
                    flagIcon.title = 'This claim is flagged for review';
                    flagIcon.innerHTML = '<span class="material-icons" style="font-size: 16px;">flag</span>';
                    actionsDiv.appendChild(flagIcon);
                }
            }
            break;
        }
    }
}
</script>