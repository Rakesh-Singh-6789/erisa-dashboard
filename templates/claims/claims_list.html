{% extends 'base.html' %}
{% load humanize %}

{% block title %}Claims Analysis - ERISA Assessment{% endblock %}

{% block content %}
{% csrf_token %}
<div style="background: #f5f5f5; min-height: 100vh; padding: 0;">
    
    <!-- Top Search Bar -->
    <div style="background: white; border-bottom: 1px solid #e0e0e0; padding: 24px 0;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 24px;">
            <!-- Search Row -->
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="flex: 1; position: relative;">
                    <form method="get" action="{% url 'claims:claims_list' %}">
                        <div style="position: relative;">
                            <span class="material-icons" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #9e9e9e; font-size: 20px;">search</span>
                            <input 
                                type="text" 
                                name="search" 
                                value="{{ current_search }}"
                                placeholder="Search claims by ID, patient name, or insurer..."
                                style="width: 100%; padding: 16px 16px 16px 52px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 16px; outline: none; background: white; transition: all 0.2s ease;"
                                autocomplete="off"
                                onfocus="this.style.borderColor='#7c4dff'; this.style.boxShadow='0 0 0 3px rgba(124, 77, 255, 0.1)'"
                                onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"
                            >
                        </div>
                        
                        <!-- Hidden fields to preserve filters -->
                        {% for key, value in request.GET.items %}
                            {% if key != 'search' and key != 'page' %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                            {% endif %}
                        {% endfor %}
                    </form>
                </div>
                
                <!-- Filter Toggle Button -->
                <button 
                    id="filterToggle"
                    style="padding: 16px 24px; border: 1px solid #e0e0e0; background: white; border-radius: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 16px; color: #495057; white-space: nowrap; transition: all 0.2s ease;"
                    onclick="toggleFilter()"
                    onmouseover="this.style.borderColor='#7c4dff'; this.style.color='#7c4dff'"
                    onmouseout="this.style.borderColor='#e0e0e0'; this.style.color='#495057'"
                >
                    <span class="material-icons" style="font-size: 20px;">tune</span>
                    Filters
                </button>
            </div>

            <!-- Filter Panel (Hidden by default, appears below search) -->
            <div id="filterPanel" style="display: none; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
                    <span class="material-icons" style="font-size: 18px; color: #6c757d;">tune</span>
                    <h6 style="margin: 0; font-weight: 600; color: #212529; font-size: 14px;">Filters</h6>
                </div>
                
                <form method="get">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 12px;">Status</label>
                            <select name="status" style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="">All Statuses</option>
                                <option value="Paid" {% if current_status == 'Paid' %}selected{% endif %}>Paid</option>
                                <option value="Denied" {% if current_status == 'Denied' %}selected{% endif %}>Denied</option>
                                <option value="Under Review" {% if current_status == 'Under Review' %}selected{% endif %}>Under Review</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 12px;">Insurer</label>
                            <select name="insurer" style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; background: white;">
                                <option value="">All Insurers</option>
                                {% for insurer in insurers %}
                                    <option value="{{ insurer }}" {% if current_insurer == insurer %}selected{% endif %}>
                                        {{ insurer }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 12px;">Date From</label>
                            <input type="date" name="date_from" value="{{ current_date_from }}" 
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057; font-size: 12px;">Date To</label>
                            <input type="date" name="date_to" value="{{ current_date_to }}" 
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px;">
                        </div>
                    </div>
                    
                    <!-- Hidden search field to preserve search when filtering -->
                    {% if current_search %}
                        <input type="hidden" name="search" value="{{ current_search }}">
                    {% endif %}
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="submit" 
                                style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                            Apply Filters
                        </button>
                        
                        <button type="button" 
                                onclick="window.location.href='{% url "claims:claims_list" %}'"
                                style="padding: 12px 24px; background: transparent; color: #6c757d; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            Clear All
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
        
        <!-- Claims Table (Full Width) -->
        <div style="background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
            
            <!-- Table Header -->
            <div style="background: #fafafa; border-bottom: 1px solid #e9ecef; padding: 0;">
                <div style="display: grid; grid-template-columns: 100px 180px 120px 120px 120px 150px 120px 100px; gap: 16px; padding: 16px 20px; font-size: 11px; font-weight: 600; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px;">
                    <div>CLAIM ID</div>
                    <div>PATIENT</div>
                    <div>BILLED</div>
                    <div>PAID</div>
                    <div>STATUS</div>
                    <div>INSURER</div>
                    <div>DISCHARGE DATE</div>
                    <div>ACTIONS</div>
                </div>
            </div>

            <!-- Table Body -->
            <div style="max-height: 600px; overflow-y: auto;">
                {% for claim in claims %}
                    <div data-claim-id="{{ claim.claim_id }}" style="display: grid; grid-template-columns: 100px 180px 120px 120px 120px 150px 120px 100px; gap: 16px; padding: 16px 20px; border-bottom: 1px solid #f1f3f4; align-items: center; transition: background-color 0.2s ease;" 
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        
                        <!-- Claim ID -->
                        <div>
                            <span style="color: #1976d2; font-weight: 500; font-size: 14px;">{{ claim.claim_id }}</span>
                        </div>
                        
                        <!-- Patient -->
                        <div>
                            <span style="color: #212529; font-size: 14px;">{{ claim.patient_name }}</span>
                        </div>
                        
                        <!-- Billed -->
                        <div>
                            <span style="color: #212529; font-size: 14px; font-weight: 500;">${{ claim.billed_amount|floatformat:2|intcomma }}</span>
                        </div>
                        
                        <!-- Paid -->
                        <div>
                            {% if claim.paid_amount == 0 %}
                                <span style="color: #dc3545; font-size: 14px; font-weight: 500;">${{ claim.paid_amount|floatformat:2|intcomma }}</span>
                            {% else %}
                                <span style="color: #28a745; font-size: 14px; font-weight: 500;">${{ claim.paid_amount|floatformat:2|intcomma }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- Status -->
                        <div>
                            {% if claim.status == 'Paid' %}
                                <span class="status-chip status-chip--paid" style="display:inline-block;width:120px;height:28px;line-height:28px;text-align:center;border-radius:14px;font-size:12px;font-weight:600;background:#cfeee0;color:#155724;border:1px solid #9fd9bb;">Paid</span>
                            {% elif claim.status == 'Denied' %}
                                <span class="status-chip status-chip--denied" style="display:inline-block;width:120px;height:28px;line-height:28px;text-align:center;border-radius:14px;font-size:12px;font-weight:600;background:#ffd9df;color:#721c24;border:1px solid #f5aeb6;">Denied</span>
                            {% else %}
                                <span class="status-chip status-chip--review" style="display:inline-block;width:120px;height:28px;line-height:28px;text-align:center;border-radius:14px;font-size:12px;font-weight:600;background:#d6e9ff;color:#004085;border:1px solid #a6ccff;">Under Review</span>
                            {% endif %}
                        </div>
                        
                        <!-- Insurer -->
                        <div>
                            <span style="color: #6c757d; font-size: 14px;">{{ claim.insurer_name }}</span>
                        </div>
                        
                        <!-- Discharge Date -->
                        <div>
                            <span style="color: #6c757d; font-size: 14px;">{{ claim.discharge_date|date:"n/j/Y" }}</span>
                        </div>
                        
                        <!-- Actions -->
                        <div class="claim-actions" style="display: flex; align-items: center; gap: 8px;">
                            <button 
                                onclick="showClaimDetail('{{ claim.claim_id }}')"
                                style="background: none; border: none; color: #6c757d; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s ease;"
                                onmouseover="this.style.background='#f8f9fa'; this.style.color='#495057';"
                                onmouseout="this.style.background='none'; this.style.color='#6c757d';"
                            >
                                <span class="material-icons" style="font-size: 16px;">visibility</span>
                                View
                            </button>
                            {% if claim.flags.exists %}
                                <span 
                                    class="flag-icon"
                                    style="color: #dc3545; display: flex; align-items: center; font-size: 16px; padding: 4px;"
                                    title="This claim is flagged for review"
                                >
                                    <span class="material-icons" style="font-size: 16px;">flag</span>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div style="text-align: center; padding: 48px; color: #6c757d;">
                        No claims found matching your criteria
                    </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <div style="padding: 16px 20px; border-top: 1px solid #f1f3f4; display: flex; justify-content: space-between; align-items: center;">
                    <!-- Page Info -->
                    <div style="color: #6c757d; font-size: 14px;">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} 
                        ({{ page_obj.paginator.count|intcomma }} total claims)
                    </div>
                    
                    <!-- Pagination Controls -->
                    <nav>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <!-- First Page -->
                            {% if page_obj.has_previous %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" 
                                   style="padding: 8px 10px; border: 1px solid #dee2e6; background: white; color: #495057; text-decoration: none; border-radius: 4px; display: flex; align-items: center; transition: all 0.2s ease;"
                                   onmouseover="this.style.background='#f8f9fa'"
                                   onmouseout="this.style.background='white'"
                                   title="First page">
                                    <span class="material-icons" style="font-size: 16px;">first_page</span>
                                </a>
                            {% else %}
                                <span style="padding: 8px 10px; border: 1px solid #e9ecef; background: #f8f9fa; color: #adb5bd; border-radius: 4px; display: flex; align-items: center;">
                                    <span class="material-icons" style="font-size: 16px;">first_page</span>
                                </span>
                            {% endif %}

                            <!-- Previous Page -->
                            {% if page_obj.has_previous %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; background: white; color: #495057; text-decoration: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease;"
                                   onmouseover="this.style.background='#f8f9fa'"
                                   onmouseout="this.style.background='white'"
                                   title="Previous page">
                                    <span class="material-icons" style="font-size: 16px;">chevron_left</span>
                                    Previous
                                </a>
                            {% else %}
                                <span style="padding: 8px 12px; border: 1px solid #e9ecef; background: #f8f9fa; color: #adb5bd; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                                    <span class="material-icons" style="font-size: 16px;">chevron_left</span>
                                    Previous
                                </span>
                            {% endif %}

                            <!-- Current Page -->
                            <span style="padding: 8px 16px; background: #007bff; color: white; border-radius: 4px; font-size: 14px; font-weight: 500; margin: 0 8px;">
                                {{ page_obj.number }}
                            </span>

                            <!-- Next Page -->
                            {% if page_obj.has_next %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" 
                                   style="padding: 8px 12px; border: 1px solid #dee2e6; background: white; color: #495057; text-decoration: none; border-radius: 4px; display: flex; align-items: center; gap: 4px; transition: all 0.2s ease;"
                                   onmouseover="this.style.background='#f8f9fa'"
                                   onmouseout="this.style.background='white'"
                                   title="Next page">
                                    Next
                                    <span class="material-icons" style="font-size: 16px;">chevron_right</span>
                                </a>
                            {% else %}
                                <span style="padding: 8px 12px; border: 1px solid #e9ecef; background: #f8f9fa; color: #adb5bd; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                                    Next
                                    <span class="material-icons" style="font-size: 16px;">chevron_right</span>
                                </span>
                            {% endif %}

                            <!-- Last Page -->
                            {% if page_obj.has_next %}
                                <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" 
                                   style="padding: 8px 10px; border: 1px solid #dee2e6; background: white; color: #495057; text-decoration: none; border-radius: 4px; display: flex; align-items: center; transition: all 0.2s ease;"
                                   onmouseover="this.style.background='#f8f9fa'"
                                   onmouseout="this.style.background='white'"
                                   title="Last page">
                                    <span class="material-icons" style="font-size: 16px;">last_page</span>
                                </a>
                            {% else %}
                                <span style="padding: 8px 10px; border: 1px solid #e9ecef; background: #f8f9fa; color: #adb5bd; border-radius: 4px; display: flex; align-items: center;">
                                    <span class="material-icons" style="font-size: 16px;">last_page</span>
                                </span>
                            {% endif %}
                        </div>
                    </nav>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal for Claim Details -->
<div id="claimModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="max-width: 900px; width: 90%; max-height: 90%; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow-y: auto;">
        <div id="claimModalContent">
            <!-- Content loaded via HTMX -->
        </div>
    </div>
</div>

<script>
function showClaimDetail(claimId) {
    console.log('Loading claim detail for:', claimId);
    
    // Show loading state
    document.getElementById('claimModalContent').innerHTML = `
        <div style="padding: 40px; text-align: center;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #7c4dff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 16px; color: #6c757d;">Loading claim details...</p>
        </div>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    `;
    
    // Show modal
    const modal = document.getElementById('claimModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Load claim details via HTMX
    htmx.ajax('GET', `/claim/${claimId}/`, {
        target: '#claimModalContent',
        swap: 'innerHTML'
    }).catch(error => {
        console.error('Error loading claim detail:', error);
        document.getElementById('claimModalContent').innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <span class="material-icons" style="font-size: 48px; color: #dc3545; margin-bottom: 16px;">error</span>
                <p style="color: #dc3545; margin: 0;">Error loading claim details</p>
            </div>
        `;
    });
}

function hideClaimModal() {
    const modal = document.getElementById('claimModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}



// Close modal when clicking outside
document.getElementById('claimModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideClaimModal();
    }
});

function toggleFilter() {
    const filterPanel = document.getElementById('filterPanel');
    const filterToggle = document.getElementById('filterToggle');
    
    if (filterPanel.style.display === 'none' || filterPanel.style.display === '') {
        filterPanel.style.display = 'block';
        filterToggle.style.background = '#e3f2fd';
        filterToggle.style.borderColor = '#007bff';
        filterToggle.style.color = '#007bff';
    } else {
        filterPanel.style.display = 'none';
        filterToggle.style.background = 'white';
        filterToggle.style.borderColor = '#e0e0e0';
        filterToggle.style.color = '#495057';
    }
}

// Auto-submit search on enter
document.querySelector('input[name="search"]').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        this.form.submit();
    }
});

// Show filter panel if filters are active
document.addEventListener('DOMContentLoaded', function() {
    const hasActiveFilters = {{ current_status|yesno:"true,false" }} || 
                           {{ current_insurer|yesno:"true,false" }} || 
                           {{ current_date_from|yesno:"true,false" }} || 
                           {{ current_date_to|yesno:"true,false" }};
    
    if (hasActiveFilters) {
        document.getElementById('filterPanel').style.display = 'block';
        const filterToggle = document.getElementById('filterToggle');
        filterToggle.style.background = '#e3f2fd';
        filterToggle.style.borderColor = '#007bff';
        filterToggle.style.color = '#007bff';
    }
});

// Debug HTMX
document.addEventListener('htmx:configRequest', function(evt) {
    console.log('HTMX Request:', evt.detail);
});

document.addEventListener('htmx:responseError', function(evt) {
    console.error('HTMX Error:', evt.detail);
});

document.addEventListener('htmx:afterRequest', function(evt) {
    console.log('HTMX Response:', evt.detail);
});
</script>

{% endblock %}